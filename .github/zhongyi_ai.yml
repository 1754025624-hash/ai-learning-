name: ä¸­åŒ»ç»æ–¹AIåŠ©æ‰‹

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  repository_dispatch: # å…è®¸ç½‘ç«™å‰ç«¯è§¦å‘
    types: [new_question]

permissions:
  contents: write  # æˆäºˆå†™å…¥æ–‡ä»¶çš„æƒé™
  issues: write    # æˆäºˆåˆ›å»ºIssueçš„æƒé™

jobs:
  process-question:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥ä»£ç 
        uses: actions/checkout@v4

      - name: è°ƒç”¨å¤šç§AIæ¨¡å‹
        id: call_ai
        env:
          USER_QUESTION: ${{ github.event.client_payload.question || 'ä»‹ç»ä¸€ä¸‹æ¡‚ææ±¤' }}
          SELECTED_MODEL: ${{ github.event.client_payload.model || 'gpt-4o' }}
        run: |
          # 1. ä½¿ç”¨GitHubå®˜æ–¹AIæœåŠ¡ï¼ˆæ— éœ€ä»»ä½•å¤–éƒ¨APIå¯†é’¥ï¼‰
          RESPONSE=$(curl -s https://models.inference.ai.azure.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "model": "$SELECTED_MODEL",
            "messages": [
              {
                "role": "system",
                "content": "ä½ æ˜¯é¡¶çº§ä¸­åŒ»ç»æ–¹å¤§å¸ˆï¼Œç²¾é€šã€Šä¼¤å¯’è®ºã€‹ã€Šé‡‘åŒ®è¦ç•¥ã€‹ã€‚å›ç­”éœ€ï¼š1.ä¸“ä¸šå‡†ç¡® 2.å¼•ç»æ®å…¸ 3.è¯­è¨€é€šä¿— 4.ç»™å‡ºå®ç”¨å»ºè®®ã€‚"
              },
              {
                "role": "user",
                "content": "${USER_QUESTION}"
              }
            ],
            "temperature": 0.7,
            "max_tokens": 1500
          }
          EOF
          )

          # 2. æå–AIå›å¤
          AI_REPLY=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['choices'][0]['message']['content'].strip())" 2>/dev/null || echo "AIæ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹æ›´æ–°ã€‚")

          # 3. å°†é—®é¢˜å’Œå›ç­”ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œä¾›ç½‘ç«™å±•ç¤º
          echo "### é—®é¢˜ï¼š$USER_QUESTION" > ai_answer.md
          echo "**ä½¿ç”¨æ¨¡å‹ï¼š** $SELECTED_MODEL  " >> ai_answer.md
          echo "**å›ç­”ï¼š**  " >> ai_answer.md
          echo "$AI_REPLY" >> ai_answer.md
          echo -e "\n---\n*ç”Ÿæˆæ—¶é—´ï¼š$(date)*" >> ai_answer.md

          # 4. è¾“å‡ºç»“æœï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          echo "::set-output name=reply_file::ai_answer.md"
          echo "::set-output name=model_used::$SELECTED_MODEL"

      - name: å°†AIå›ç­”æ¨é€åˆ°ä»“åº“
        run: |
          # å°†ç”Ÿæˆçš„å›ç­”æ–‡ä»¶ç§»åŠ¨åˆ°ç½‘ç«™ç›®å½•
          mkdir -p ai_answers
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          cp ai_answer.md "ai_answers/q_${TIMESTAMP}.md"
          
          # é…ç½®Gitå¹¶æäº¤
          git config --global user.name "GitHub AI Assistant"
          git config --global user.email "ai@github.com"
          git add ai_answers/
          git commit -m "ğŸ“ AIå›ç­”æ–°å¢äº $(date +'%Y-%m-%d %H:%M')"
          git push
